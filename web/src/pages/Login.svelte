<script lang="ts">
  import config from "@/config";

  import Icon from "@/components/Icon.svelte";
  import Button from '@/components/Button.svelte';
  import Logo from "@/components/Logo.svelte";

  let providers: string[] = config.runtime.TERRALIST_OAUTH_PROVIDERS.sort();

  let formRef: { [provider: string]: HTMLFormElement } = Object.fromEntries(providers.map(p => [p, null]));

  const hostUrl: string = config.runtime.TERRALIST_HOST_URL;
  const authorizationEndpoint: string = config.runtime.TERRALIST_AUTHORIZATION_ENDPOINT;

  const providersDisplayName = {
    "bitbucket": "BitBucket",
    "github": "GitHub",
    "gitlab": "GitLab",
    "google": "Google",
  };

  let loginDisabled: boolean = false;

  const onLogin = async (provider: string) => {
    if (!loginDisabled) {
      loginDisabled = true;
      formRef[provider].submit();
    }
  };
</script>

<svelte:head>
  <style lang="css">
    @keyframes pan {
      100% { background-position-x: -75px; }
    }

    body {
      background-image: url("data:image/svg+xml;utf8,<svg id='visual' viewBox='0 0 900 450' width='900' height='450' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' version='1.1'><path d='M0 19L15 20.5C30 22 60 25 90 24.3C120 23.7 150 19.3 180 18.7C210 18 240 21 270 23.2C300 25.3 330 26.7 360 26.7C390 26.7 420 25.3 450 26.2C480 27 510 30 540 27C570 24 600 15 630 9.5C660 4 690 2 720 2.7C750 3.3 780 6.7 810 7.7C840 8.7 870 7.3 885 6.7L900 6L900 0L885 0C870 0 840 0 810 0C780 0 750 0 720 0C690 0 660 0 630 0C600 0 570 0 540 0C510 0 480 0 450 0C420 0 390 0 360 0C330 0 300 0 270 0C240 0 210 0 180 0C150 0 120 0 90 0C60 0 30 0 15 0L0 0Z' fill='%2300ffc1'></path><path d='M0 33L15 42C30 51 60 69 90 75C120 81 150 75 180 69C210 63 240 57 270 54.7C300 52.3 330 53.7 360 49.2C390 44.7 420 34.3 450 32.2C480 30 510 36 540 40.5C570 45 600 48 630 51.7C660 55.3 690 59.7 720 55.2C750 50.7 780 37.3 810 40.3C840 43.3 870 62.7 885 72.3L900 82L900 4L885 4.7C870 5.3 840 6.7 810 6C780 5.3 750 2.7 720 2C690 1.3 660 2.7 630 7.8C600 13 570 22 540 25C510 28 480 25 450 24.2C420 23.3 390 24.7 360 24.7C330 24.7 300 23.3 270 21.2C240 19 210 16 180 16.7C150 17.3 120 21.7 90 22.3C60 23 30 20 15 18.5L0 17Z' fill='%2316f6b9'></path><path d='M0 78L15 94.5C30 111 60 144 90 147.7C120 151.3 150 125.7 180 115.2C210 104.7 240 109.3 270 117.7C300 126 330 138 360 145.5C390 153 420 156 450 143.2C480 130.3 510 101.7 540 110.7C570 119.7 600 166.3 630 179.2C660 192 690 171 720 165.7C750 160.3 780 170.7 810 163.2C840 155.7 870 130.3 885 117.7L900 105L900 80L885 70.3C870 60.7 840 41.3 810 38.3C780 35.3 750 48.7 720 53.2C690 57.7 660 53.3 630 49.7C600 46 570 43 540 38.5C510 34 480 28 450 30.2C420 32.3 390 42.7 360 47.2C330 51.7 300 50.3 270 52.7C240 55 210 61 180 67C150 73 120 79 90 73C60 67 30 49 15 40L0 31Z' fill='%2320edb1'></path><path d='M0 168L15 184.5C30 201 60 234 90 241.5C120 249 150 231 180 223.5C210 216 240 219 270 217.5C300 216 330 210 360 203.2C390 196.3 420 188.7 450 194.7C480 200.7 510 220.3 540 226.3C570 232.3 600 224.7 630 214.2C660 203.7 690 190.3 720 185.8C750 181.3 780 185.7 810 202.8C840 220 870 250 885 265L900 280L900 103L885 115.7C870 128.3 840 153.7 810 161.2C780 168.7 750 158.3 720 163.7C690 169 660 190 630 177.2C600 164.3 570 117.7 540 108.7C510 99.7 480 128.3 450 141.2C420 154 390 151 360 143.5C330 136 300 124 270 115.7C240 107.3 210 102.7 180 113.2C150 123.7 120 149.3 90 145.7C60 142 30 109 15 92.5L0 76Z' fill='%2327e4a8'></path><path d='M0 258L15 268.5C30 279 60 300 90 303.7C120 307.3 150 293.7 180 280.2C210 266.7 240 253.3 270 248.8C300 244.3 330 248.7 360 240.3C390 232 420 211 450 214.8C480 218.7 510 247.3 540 260.8C570 274.3 600 272.7 630 266.7C660 260.7 690 250.3 720 245.8C750 241.3 780 242.7 810 253.2C840 263.7 870 283.3 885 293.2L900 303L900 278L885 263C870 248 840 218 810 200.8C780 183.7 750 179.3 720 183.8C690 188.3 660 201.7 630 212.2C600 222.7 570 230.3 540 224.3C510 218.3 480 198.7 450 192.7C420 186.7 390 194.3 360 201.2C330 208 300 214 270 215.5C240 217 210 214 180 221.5C150 229 120 247 90 239.5C60 232 30 199 15 182.5L0 166Z' fill='%232cdba0'></path><path d='M0 262L15 271.8C30 281.7 60 301.3 90 305.2C120 309 150 297 180 283.5C210 270 240 255 270 251.2C300 247.3 330 254.7 360 250.8C390 247 420 232 450 235.8C480 239.7 510 262.3 540 275.8C570 289.3 600 293.7 630 289.2C660 284.7 690 271.3 720 267.7C750 264 780 270 810 279C840 288 870 300 885 306L900 312L900 301L885 291.2C870 281.3 840 261.7 810 251.2C780 240.7 750 239.3 720 243.8C690 248.3 660 258.7 630 264.7C600 270.7 570 272.3 540 258.8C510 245.3 480 216.7 450 212.8C420 209 390 230 360 238.3C330 246.7 300 242.3 270 246.8C240 251.3 210 264.7 180 278.2C150 291.7 120 305.3 90 301.7C60 298 30 277 15 266.5L0 256Z' fill='%232ed89d'></path><path d='M0 343L15 352.8C30 362.7 60 382.3 90 387.7C120 393 150 384 180 367.5C210 351 240 327 270 320.2C300 313.3 330 323.7 360 321.3C390 319 420 304 450 299.5C480 295 510 301 540 305.5C570 310 600 313 630 316C660 319 690 322 720 322C750 322 780 319 810 325C840 331 870 346 885 353.5L900 361L900 310L885 304C870 298 840 286 810 277C780 268 750 262 720 265.7C690 269.3 660 282.7 630 287.2C600 291.7 570 287.3 540 273.8C510 260.3 480 237.7 450 233.8C420 230 390 245 360 248.8C330 252.7 300 245.3 270 249.2C240 253 210 268 180 281.5C150 295 120 307 90 303.2C60 299.3 30 279.7 15 269.8L0 260Z' fill='%232ed89d'></path><path d='M0 384L15 389.2C30 394.3 60 404.7 90 403.2C120 401.7 150 388.3 180 369.7C210 351 240 327 270 322.5C300 318 330 333 360 338.2C390 343.3 420 338.7 450 338.7C480 338.7 510 343.3 540 344.8C570 346.3 600 344.7 630 346.8C660 349 690 355 720 351.3C750 347.7 780 334.3 810 341.2C840 348 870 375 885 388.5L900 402L900 359L885 351.5C870 344 840 329 810 323C780 317 750 320 720 320C690 320 660 317 630 314C600 311 570 308 540 303.5C510 299 480 293 450 297.5C420 302 390 317 360 319.3C330 321.7 300 311.3 270 318.2C240 325 210 349 180 365.5C150 382 120 391 90 385.7C60 380.3 30 360.7 15 350.8L0 341Z' fill='%232cdba0'></path><path d='M0 402L15 406.5C30 411 60 420 90 417.7C120 415.3 150 401.7 180 384.3C210 367 240 346 270 340.8C300 335.7 330 346.3 360 351.7C390 357 420 357 450 355.5C480 354 510 351 540 348.7C570 346.3 600 344.7 630 352.8C660 361 690 379 720 381.3C750 383.7 780 370.3 810 376.3C840 382.3 870 407.7 885 420.3L900 433L900 400L885 386.5C870 373 840 346 810 339.2C780 332.3 750 345.7 720 349.3C690 353 660 347 630 344.8C600 342.7 570 344.3 540 342.8C510 341.3 480 336.7 450 336.7C420 336.7 390 341.3 360 336.2C330 331 300 316 270 320.5C240 325 210 349 180 367.7C150 386.3 120 399.7 90 401.2C60 402.7 30 392.3 15 387.2L0 382Z' fill='%2327e4a8'></path><path d='M0 406L15 410.5C30 415 60 424 90 424.8C120 425.7 150 418.3 180 409.3C210 400.3 240 389.7 270 385.8C300 382 330 385 360 388C390 391 420 394 450 396.3C480 398.7 510 400.3 540 396.7C570 393 600 384 630 386.2C660 388.3 690 401.7 720 405.3C750 409 780 403 810 406.8C840 410.7 870 424.3 885 431.2L900 438L900 431L885 418.3C870 405.7 840 380.3 810 374.3C780 368.3 750 381.7 720 379.3C690 377 660 359 630 350.8C600 342.7 570 344.3 540 346.7C510 349 480 352 450 353.5C420 355 390 355 360 349.7C330 344.3 300 333.7 270 338.8C240 344 210 365 180 382.3C150 399.7 120 413.3 90 415.7C60 418 30 409 15 404.5L0 400Z' fill='%2320edb1'></path><path d='M0 451L15 448C30 445 60 439 90 436C120 433 150 433 180 431.5C210 430 240 427 270 427C300 427 330 430 360 431.5C390 433 420 433 450 432.3C480 431.7 510 430.3 540 428.8C570 427.3 600 425.7 630 423.3C660 421 690 418 720 419.5C750 421 780 427 810 433C840 439 870 445 885 448L900 451L900 436L885 429.2C870 422.3 840 408.7 810 404.8C780 401 750 407 720 403.3C690 399.7 660 386.3 630 384.2C600 382 570 391 540 394.7C510 398.3 480 396.7 450 394.3C420 392 390 389 360 386C330 383 300 380 270 383.8C240 387.7 210 398.3 180 407.3C150 416.3 120 423.7 90 422.8C60 422 30 413 15 408.5L0 404Z' fill='%2316f6b9'></path><path d='M0 451L15 451C30 451 60 451 90 451C120 451 150 451 180 451C210 451 240 451 270 451C300 451 330 451 360 451C390 451 420 451 450 451C480 451 510 451 540 451C570 451 600 451 630 451C660 451 690 451 720 451C750 451 780 451 810 451C840 451 870 451 885 451L900 451L900 449L885 446C870 443 840 437 810 431C780 425 750 419 720 417.5C690 416 660 419 630 421.3C600 423.7 570 425.3 540 426.8C510 428.3 480 429.7 450 430.3C420 431 390 431 360 429.5C330 428 300 425 270 425C240 425 210 428 180 429.5C150 431 120 431 90 434C60 437 30 443 15 446L0 449Z' fill='%2300ffc1'></path></svg>");
      background-repeat: no-repeat;
      background-size: cover;
      animation: 
        pan 6s infinite alternate linear;
    }
  </style>
</svelte:head>

<main class="grid place-items-center w-screen h-screen m-0 py-0 px-6 lg:px-0">
  <header class="hidden md:flex h-full w-full pr-96 items-center justify-center">
    <Logo />
  </header>
  <container
    class="
      fixed
      top-50
      left-50
      w-11/12
      pt-16
      pb-11
      px-8
      transition-width
      trainsition-slowest
      ease
      rounded-2xl
      bg-slate-200
      grid
      place-items-center
      text-center
      sm:w-96
      md:top-0
      md:right-0
      md:left-auto
      md:m-0
      md:h-full
      md:rounded-none
      md:translate-x-0
      md:translate-y-0
      xl:w-1/4
    "
  >
    <Logo class="mb-5 md:hidden" />
    <div class="mb-8">
      <h2 class="text-3xl font-semibold mt-0 mx-0">
        Terralist
      </h2>
      <h4 class="opacity-40 mb-1.5 font-medium text-xs">{config.build.TERRALIST_VERSION}</h4>
      {#if config.runtime.TERRALIST_COMPANY_NAME}
        <h3 class="opacity-40 mb-1.5 font-medium text-base">{config.runtime.TERRALIST_COMPANY_NAME}</h3>
      {/if}
    </div>
    <section class="grid gap-8 place-items-center w-full m-0">
      {#each providers as provider}
        {#if providersDisplayName[provider]}
          <form class="w-full" bind:this={formRef[provider]} method="get" action={authorizationEndpoint}>
            <input type="hidden" name="redirect_uri" value={hostUrl} />
            <Button class="w-full grid grid-cols-6 place-items-center h-10" onClick={() => onLogin(provider)} disabled={loginDisabled}>
              <Icon name={provider} />
              <span class={loginDisabled ? "col-span-4" : "col-span-5"}>Continue with {providersDisplayName[provider]}</span>
              {#if loginDisabled}
                <Icon name={"circle-loader"} class={"stroke-white"} />
              {/if}
            </Button>
          </form>
        {/if}
      {/each}
    </section>
  </container>
</main>
